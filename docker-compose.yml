version: '3'

services:
  # --- 1. CHROMA DB ---
  chroma-server:
    image: chromadb/chroma:latest
    container_name: faq_chroma_server
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - ./data/chroma_data:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=False

  # --- 2. POSTGRES DATABASE ---
  postgres:
    image: postgres:15-alpine
    container_name: faq_postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: adminpassword
      POSTGRES_DB: evolution
    volumes:
      # GANTI KE V5 (Clean Start Otomatis)
      - ./postgres_data_v5:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # --- 3. EVOLUTION API ---
# --- 3. EVOLUTION API ---
evolution-api:
    container_name: faq_evolution
    depends_on:
      postgres:
        condition: service_healthy
        required: true
    environment:
      AUTHENTICATION_API_KEY: admin123
      AUTHENTICATION_EXPOSE_IN_URL: "true"
      DATABASE_PROVIDER: postgresql
      DATABASE_URL: postgresql://postgres:adminpassword@faq_postgres:5432/evolution?schema=public
      # GANTI LOG LEVEL JADI WARN BIAR GAK ERROR SEPERTI ISU GITHUB #1695
      LOG_LEVEL: WARN
      SERVER_PORT: "8081"
      SERVER_TYPE: http
      # --- BAGIAN PENTING: GANTI KE IP PUBLIC VPS ---
      # Jangan localhost. Browser kamu gak bisa baca localhost server.
      SERVER_URL: http://172.26.12.104:8081 
    image: evoapicloud/evolution-api:v2.2.2
    networks:
      default: null
    ports:
      - mode: ingress
        target: 8081
        published: "8081"
        protocol: tcp
    restart: always
    volumes:
      # Volume .env HAPUS AJA (Bikin konflik)
      - type: bind
        source: /home/ubuntu/eighthExperiment/evolution_instances_v5
        target: /evolution/instances
        bind:
          create_host_path: true
      - type: bind
        source: /home/ubuntu/eighthExperiment/evolution_store_v5
        target: /evolution/store
        bind:
          create_host_path: true

  # --- 4. BOT WA ---
  faq-bot:
    build: .
    container_name: faq_bot_wa
    restart: always
    ports:
      - "8005:8000"
    depends_on:
      - chroma-server
      - evolution-api
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
      - EVO_BASE_URL=http://evolution-api:8081
      - EVO_API_KEY=admin123
    command: uvicorn bot_wa:app --host 0.0.0.0 --port 8000

  # --- 5. USER APP ---
  faq-user:
    build: .
    container_name: faq_user_app
    restart: always
    ports:
      - "8501:8501"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    command: streamlit run app.py --server.port=8501 --server.address=0.0.0.0

  # --- 6. ADMIN APP ---
  faq-admin:
    build: .
    container_name: faq_admin_app
    restart: always
    ports:
      - "8502:8502"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    command: streamlit run admin.py --server.port=8502 --server.address=0.0.0.0

  # --- 7. FRONTEND V2 ---
  faq-web-v2:
    build: .
    container_name: faq_web_v2
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./web_v2:/app/web_v2
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    command: uvicorn web_v2.main:app --host 0.0.0.0 --port 8080